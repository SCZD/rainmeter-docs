<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Nested Expressions - Rainmeter Snippets</title>
	<link href="../../css/main.css" rel="stylesheet">
	<link rel="shortcut icon" href="//rainmeter.net/favicon.ico">
	<!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6/html5shiv.min.js"></script><![endif]-->
</head>
<body>
	<div id="wrapper">
		<div id="top">
			<div class="container">
				<a id="logo" href="//rainmeter.net/"></a>
				<nav id="nav">
					<ul>
					<li><a href="//rainmeter.net">Home</a>
					<li><a href="//rainmeter.net/about">About</a>
					<li><a href="/" class="active">Docs</a>
					<li><a href="//rainmeter.net/discover">Discover</a>
					<li><a href="//rainmeter.net/forum">Forum</a>
					</ul>
				</nav>
			</div>
		</div>

		<div class="container">
			<div class="row">
				<div id="side-content">
	<h1 id="category"><a href="/snippets">Snippets</a></h1>

	<form id="search-form" method="get" action="http://www.google.com/search">
		<input name="sitesearch" value="docs.rainmeter.net" type="hidden">
		<input id="search" name="q" maxlength="255" size="16" placeholder="Search" type="text">
	</form>

	<nav id="tree">
		<h1>Contents</h1>
<ul>
<li><a href="/snippets#General">General</a>
<li><a href="/snippets#Conversions">Conversions</a>
<li><a href="/snippets#FileInputOutput">File Input &amp; Output</a>
<li><a href="/snippets#Math">Math</a>
<li><a href="/snippets#Methods">Methods</a>
<li><a href="/snippets#Rainmeter">Rainmeter</a>
<li><a href="/snippets#Strings">Strings</a>
<li><a href="/snippets#Time">Time</a>
</ul>

<h1>More</h1>
<ul>
<li><a href="/manual">3.2 Final Manual</a>
<li><a href="/manual-beta">3.3 Beta Manual</a>
<li><a href="/tips">Tips &amp; Tricks</a>
<li><a href="/developers">Developers</a>
<li><a href="/history">Version History</a>
</ul>

	</nav>
</div>
<div id="content">
	<header>
		<h1>Nested Expressions</h1>
	</header>
	<article><p>Lua can get pretty complicated, especially when you want to create strings using values based on other values. This usually also includes a lot of concatenation.</p>

<div class="noscroll">
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="string">'On '</span> .. <span class="built_in">os</span>.date(<span class="string">'&amp;#37;A'</span>) .. <span class="string">' Jane goes to '</span> .. Locations[<span class="built_in">os</span>.date(<span class="string">'&amp;#37;a'</span>)] .. <span class="string">'.'</span></span><br></pre></td></tr></table></figure>

</div>

<p>Using a little ingenuity this task could get a lot simpler.</p>

<div class="noscroll">
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="string">'On &#123;LongDay&#125; Jane goes to &#123;&amp;#123;ShortDay&amp;#125;Location&#125;.'</span></span><br></pre></td></tr></table></figure>

</div>

<p>This is something called Nested Expressions. This could be an insurmountable task, but thankfully it's not. As long as we follow some rules we can use one of Lua's built in functions for this.</p>

<p>The most important rule we need to follow is that our expression must begin and end with different characters. For example, let's use the curly brackets (i.e. <code>'{Expression}'</code>). If both characters were the same Lua wouldn't be able to tell the difference between the beginning and the end.</p>

<p>Now we need to define a function for our needs. Yes, we really do need a function for this. Since we need to follow the same steps for each nested expression we will need to call the function inside itself.</p>

<div class="noscroll">
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nested</span><span class="params">(line)</span></span></span><br><span class="line">	<span class="comment">-- Do Something Here</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

</div>

<p>Now we need to start adding the bits that do all the work. What makes this all possible is the balanced expression matching capability of Lua. This would be the <code>&#37;b</code> pattern matching class. We use it by placing the beginning and ending characters after it. More detail can be found <a href="http://www.lua.org/pil/20.2.html" target="_blank" rel="external">here</a>.</p>

<div class="noscroll">
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nested</span><span class="params">(line)</span></span></span><br><span class="line">	<span class="keyword">return</span> (<span class="built_in">string</span>.gsub(line, <span class="string">'&amp;#37;b&#123;&#125;'</span>, <span class="function"><span class="keyword">function</span><span class="params">(input)</span></span></span><br><span class="line">		<span class="comment">-- Do Something Here</span></span><br><span class="line">	<span class="keyword">end</span>))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

</div>

<p>Now that we have our expression we need to do something with it. The first thing is to call our function again so we can deal with the nested expressions first. We'll have to strip off the beginning and ending characters or we'll just create an infinite loop.</p>

<div class="noscroll">
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nested</span><span class="params">(line)</span></span></span><br><span class="line">	<span class="keyword">return</span> (<span class="built_in">string</span>.gsub(line, <span class="string">'&amp;#37;b&#123;&#125;'</span>, <span class="function"><span class="keyword">function</span><span class="params">(input)</span></span></span><br><span class="line">		<span class="keyword">local</span> newline = nested(<span class="built_in">string</span>.match(input, <span class="string">'^&#123;(.-)&#125;$'</span>))</span><br><span class="line">		<span class="comment">-- Do Something Here</span></span><br><span class="line">	<span class="keyword">end</span>))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

</div>

<p>Now we need to start doing something with our expression. This requires some testing. The first thing is to make sure that what we have indeed received is a valid expression and act accordingly. If it's not a valid expression we need to return exactly what we received, including the beginning and ending characters.</p>

<p>You can do whatever you want to your expression, just be sure you return something. It is important to remember to use the <code>newline</code> variable in whatever you do from this point on. This is the variable that has all of the nested expressions already evaluated.</p>

<div class="noscroll">
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nested</span><span class="params">(line)</span></span></span><br><span class="line">	<span class="keyword">return</span> (<span class="built_in">string</span>.gsub(line, <span class="string">'&amp;#37;b&#123;&#125;'</span>, <span class="function"><span class="keyword">function</span><span class="params">(input)</span></span></span><br><span class="line">		<span class="keyword">local</span> newline = nested(<span class="built_in">string</span>.match(input, <span class="string">'^&#123;(.-)&#125;$'</span>))</span><br><span class="line">		<span class="keyword">if</span> newline ~= <span class="string">''</span> <span class="keyword">then</span></span><br><span class="line">			<span class="keyword">return</span> <span class="comment">--Do Something Here</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>.format(<span class="string">'&#123;&amp;#37;s&#125;'</span>, newline)</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span>))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

</div>

<p>There is one very important thing to note. Our function as written must be a global function. If you want it to be local there is a way to fix this. We must pass the function to itself. It's best not to think about this too hard.</p>

<div class="noscroll">
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> nested = <span class="function"><span class="keyword">function</span><span class="params">(line, self)</span></span></span><br><span class="line">	<span class="keyword">return</span> (<span class="built_in">string</span>.gsub(line, <span class="string">'&amp;#37;b&#123;&#125;'</span>, <span class="function"><span class="keyword">function</span><span class="params">(input)</span></span></span><br><span class="line">		<span class="keyword">local</span> newline = self(<span class="built_in">string</span>.match(input, <span class="string">'^&#123;(.-)&#125;$'</span>), self)</span><br><span class="line">		<span class="keyword">if</span> newline ~= <span class="string">''</span> <span class="keyword">then</span></span><br><span class="line">			<span class="keyword">return</span> <span class="comment">-- Do Something Here</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>.format(<span class="string">'&#123;&amp;#37;s&#125;'</span>, newline)</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">SomeString = nested(<span class="string">'&#123;Variable&#123;AnotherVariable&#125;&#125;'</span>, nested)</span><br></pre></td></tr></table></figure>

</div>

<h2 id="Examples">Examples</h2>

<p>Here's something extremely simple. We're just going to see what Jane is doing today.</p>

<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">Variables = &#123;</span><br><span class="line">	LongDay = <span class="built_in">os</span>.date(<span class="string">'&amp;#37;A'</span>),</span><br><span class="line">	ShortDay = <span class="built_in">os</span>.date(<span class="string">'&amp;#37;a'</span>),</span><br><span class="line">	SunLocation = <span class="string">'Church'</span>,</span><br><span class="line">	MonLocation = <span class="string">'the Grocery Store'</span>,</span><br><span class="line">	TueLocation = <span class="string">'the Salon'</span>,</span><br><span class="line">	WedLocation = <span class="string">'a PTA meeting'</span>,</span><br><span class="line">	ThuLocation = <span class="string">'a concert'</span>,</span><br><span class="line">	FriLocation = <span class="string">'the bar'</span>,</span><br><span class="line">	SatLocation = <span class="string">'the beach'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nested</span><span class="params">(line)</span></span></span><br><span class="line">	<span class="keyword">return</span> (<span class="built_in">string</span>.gsub(line, <span class="string">'&amp;#37;b&#123;&#125;'</span>, <span class="function"><span class="keyword">function</span><span class="params">(input)</span></span></span><br><span class="line">		<span class="keyword">local</span> newline = nested(<span class="built_in">string</span>.match(input, <span class="string">'^&#123;(.-)&#125;$'</span>))</span><br><span class="line">		<span class="keyword">if</span> Variables[newline] <span class="keyword">then</span></span><br><span class="line">			<span class="keyword">return</span> Variables[newline]</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>.format(<span class="string">'&#123;&amp;#37;s&#125;'</span>, newline)</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">SomeString = nested(<span class="string">'On &#123;LongDay&#125; Jane goes to &#123;&#123;ShortDay&#125;Location&#125;.'</span>)</span><br></pre></td></tr></table></figure>

<p>This one is much more complicated. It's used to replace nested Rainmeter measures and variables.</p>

<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Replace</span><span class="params">(input)</span></span></span><br><span class="line">	<span class="keyword">return</span> (<span class="built_in">string</span>.gsub(input, <span class="string">'(&amp;#37;b[])'</span>, <span class="function"><span class="keyword">function</span><span class="params">(line)</span></span></span><br><span class="line">		<span class="keyword">local</span> newline = Replace(<span class="built_in">string</span>.match(line, <span class="string">'^&amp;#37;[(.-)]$'</span>))</span><br><span class="line">		<span class="keyword">local</span> typ, name = <span class="built_in">string</span>.match(newline, <span class="string">'(.)(.+)'</span>)</span><br><span class="line">		<span class="comment">-- Establish an string to return in case we encounter an error</span></span><br><span class="line">		<span class="keyword">local</span> ErrorString = <span class="built_in">string</span>.format(<span class="string">'[&amp;#37;s]'</span>, newline)</span><br><span class="line">		<span class="comment">-- Make allowance for escaped expression</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">string</span>.match(newline, <span class="string">'^&amp;#37;*(.-)&amp;#37;*$'</span>) <span class="keyword">then</span></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">string</span>.gsub(newline, <span class="string">'^&amp;#37;*(.-)&amp;#37;*$'</span>, <span class="string">'[&amp;#37;1]'</span>)</span><br><span class="line">		<span class="comment">-- Measures / Meters</span></span><br><span class="line">		<span class="keyword">elseif</span> typ == <span class="string">'&amp;'</span> <span class="keyword">then</span></span><br><span class="line">			<span class="comment">-- Make allowance for section variables</span></span><br><span class="line">			<span class="keyword">local</span> section = <span class="built_in">string</span>.match(name, <span class="string">'([^:]+)'</span>)</span><br><span class="line">			<span class="comment">-- Check if Measure / Meter exists</span></span><br><span class="line">			<span class="keyword">if</span> SKIN:GetMeasure(section) <span class="keyword">or</span> SKIN:GetMeter(section) <span class="keyword">then</span></span><br><span class="line">				<span class="comment">-- Use existing function for maximum flexibility</span></span><br><span class="line">				<span class="keyword">return</span> SKIN:ReplaceVariables(<span class="built_in">string</span>.format(<span class="string">'[&amp;#37;s]'</span>, name))</span><br><span class="line">			<span class="comment">-- Measure / Meter does not exist</span></span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="keyword">return</span> ErrorString</span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line">		<span class="comment">-- Variable</span></span><br><span class="line">		<span class="keyword">elseif</span> typ == <span class="string">'#'</span> <span class="keyword">then</span></span><br><span class="line">			<span class="keyword">return</span> SKIN:GetVariable(name) <span class="keyword">or</span> ErrorString</span><br><span class="line">		<span class="comment">-- Did not define anything we are looking for</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> ErrorString</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">SomeLine = Replace(<span class="string">'[&amp;SomeMeasure[#SomeVariable[&amp;SomeMeter:X]]]'</span>)</span><br></pre></td></tr></table></figure>

<p>Here's an example that uses a wrapper function so that we can specify a table of variables when we call the function.</p>

<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SomeFunction</span><span class="params">(InputExpression, FuncTbl)</span></span></span><br><span class="line">	<span class="keyword">local</span> nested = <span class="function"><span class="keyword">function</span><span class="params">(line, self)</span></span></span><br><span class="line">		<span class="keyword">return</span> (<span class="built_in">string</span>.gsub(line, <span class="string">'&amp;#37;b&#123;&#125;'</span>, <span class="function"><span class="keyword">function</span><span class="params">(input)</span></span></span><br><span class="line">			<span class="keyword">local</span> newline = self(<span class="built_in">string</span>.match(input, <span class="string">'^&#123;(.-)&#125;$'</span>), self)</span><br><span class="line">			<span class="keyword">if</span> FuncTbl[newline] <span class="keyword">then</span></span><br><span class="line">				<span class="keyword">return</span> FuncTbl[newline]</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="keyword">return</span> <span class="built_in">string</span>.format(<span class="string">'&#123;&amp;#37;s&#125;'</span>, newline)</span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">end</span>))</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> nested(InputExpression, nested)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Variables = &#123;</span><br><span class="line">	LongDay = <span class="built_in">os</span>.date(<span class="string">'&amp;#37;A'</span>),</span><br><span class="line">	ShortDay = <span class="built_in">os</span>.date(<span class="string">'&amp;#37;a'</span>),</span><br><span class="line">	SunLocation = <span class="string">'Church'</span>,</span><br><span class="line">	MonLocation = <span class="string">'the Grocery Store'</span>,</span><br><span class="line">	TueLocation = <span class="string">'the Salon'</span>,</span><br><span class="line">	WedLocation = <span class="string">'a PTA meeting'</span>,</span><br><span class="line">	ThuLocation = <span class="string">'a concert'</span>,</span><br><span class="line">	FriLocation = <span class="string">'the bar'</span>,</span><br><span class="line">	SatLocation = <span class="string">'the beach'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SomeString = SomeFunction(<span class="string">'On &#123;LongDay&#125; Jane goes to &#123;&#123;ShortDay&#125;Location&#125;.'</span>, Variables)</span><br></pre></td></tr></table></figure>

</article>
</div>
			</div>
		</div>

		<div id="footer-push"></div>
	</div>

	<script src="../../js/main.js"></script>
</body>
</html>
